# üöÄ Sistema de API Centralizado - Documentaci√≥n

## üìã √çndice

1. [Descripci√≥n General](#descripci√≥n-general)
2. [Arquitectura del Sistema](#arquitectura-del-sistema)
3. [Configuraci√≥n](#configuraci√≥n)
4. [Servicios Disponibles](#servicios-disponibles)
5. [Manejo de Errores](#manejo-de-errores)
6. [Autenticaci√≥n](#autenticaci√≥n)
7. [Interceptores](#interceptores)
8. [Reintentos Autom√°ticos](#reintentos-autom√°ticos)
9. [Tipos TypeScript](#tipos-typescript)
10. [Ejemplos de Uso](#ejemplos-de-uso)
11. [Migraci√≥n](#migraci√≥n)
12. [Troubleshooting](#troubleshooting)

## üéØ Descripci√≥n General

El Sistema de API Centralizado es una implementaci√≥n robusta y f√°cil de mantener que conecta la aplicaci√≥n admin con el backend de MussikOn. Est√° dise√±ado siguiendo las mejores pr√°cticas de la app m√≥vil y proporciona:

- **Configuraci√≥n centralizada** de endpoints y URLs
- **Manejo autom√°tico de autenticaci√≥n** con JWT
- **Interceptores inteligentes** para requests y responses
- **Sistema de reintentos** autom√°tico
- **Manejo de errores** centralizado
- **Tipos TypeScript** completos
- **Servicios modulares** por funcionalidad

## üèóÔ∏è Arquitectura del Sistema

```
src/
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ apiConfig.ts          # Configuraci√≥n centralizada
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ api.ts               # Cliente HTTP principal
‚îÇ   ‚îú‚îÄ‚îÄ authService.ts       # Servicio de autenticaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ mobileUsersService.ts # Servicio de usuarios m√≥viles
‚îÇ   ‚îú‚îÄ‚îÄ eventsService.ts     # Servicio de eventos
‚îÇ   ‚îî‚îÄ‚îÄ musicianRequestsService.ts # Servicio de solicitudes
‚îî‚îÄ‚îÄ features/
    ‚îî‚îÄ‚îÄ [feature]/
        ‚îú‚îÄ‚îÄ hooks/
        ‚îÇ   ‚îî‚îÄ‚îÄ use[Feature].ts # Hooks que usan los servicios
        ‚îî‚îÄ‚îÄ types/
            ‚îî‚îÄ‚îÄ [feature].ts    # Tipos espec√≠ficos
```

## ‚öôÔ∏è Configuraci√≥n

### Configuraci√≥n Base (`src/config/apiConfig.ts`)

```typescript
export const API_CONFIG = {
  BASE_URL: 'http://172.20.10.2:3001',
  TIMEOUT: 15000,
  RETRY_CONFIG: {
    maxRetries: 3,
    retryDelay: 1000,
  },
  ENDPOINTS: {
    // Autenticaci√≥n
    LOGIN: '/auth/login',
    REGISTER: '/auth/register',
    
    // Usuarios M√≥viles (Admin)
    MOBILE_USERS: '/admin/users',
    MOBILE_USER_BY_ID: '/admin/users/:id',
    // ... m√°s endpoints
  }
};
```

### Cambiar URL del Backend

Para cambiar la URL del backend, solo edita `API_CONFIG.BASE_URL` en `src/config/apiConfig.ts`:

```typescript
BASE_URL: 'http://tu-nueva-url:puerto',
```

## üîß Servicios Disponibles

### 1. Servicio de API Principal (`api.ts`)

**Funcionalidades:**
- Cliente HTTP con Axios
- Interceptores autom√°ticos
- Manejo de tokens JWT
- Sistema de reintentos
- Logging de requests/responses

**Uso:**
```typescript
import { apiService } from './services/api';

// GET
const response = await apiService.get('/endpoint');

// POST
const response = await apiService.post('/endpoint', data);

// PUT
const response = await apiService.put('/endpoint', data);

// DELETE
const response = await apiService.delete('/endpoint');
```

### 2. Servicio de Autenticaci√≥n (`authService.ts`)

**Funcionalidades:**
- Login/Logout
- Registro de usuarios
- Refresh de tokens
- Verificaci√≥n de permisos
- Gesti√≥n de sesiones

**Uso:**
```typescript
import { authService } from './services/authService';

// Login
const authResponse = await authService.login({
  userEmail: 'admin@mussikon.com',
  userPassword: 'password'
});

// Verificar autenticaci√≥n
if (authService.isAuthenticated()) {
  // Usuario autenticado
}

// Verificar permisos
if (authService.isAdmin()) {
  // Usuario es admin
}
```

### 3. Servicio de Usuarios M√≥viles (`mobileUsersService.ts`)

**Funcionalidades:**
- CRUD completo de usuarios
- Filtrado avanzado
- Estad√≠sticas
- Bloqueo/Desbloqueo

**Uso:**
```typescript
import { mobileUsersService } from './services/mobileUsersService';

// Obtener todos los usuarios
const response = await mobileUsersService.getAllUsers({
  status: 'active',
  roll: 'musico'
});

// Crear usuario
const newUser = await mobileUsersService.createUser(userData);

// Bloquear usuario
const blockedUser = await mobileUsersService.blockUser(userId, 'Raz√≥n');
```

### 4. Servicio de Eventos (`eventsService.ts`)

**Funcionalidades:**
- CRUD completo de eventos
- Filtrado por categor√≠a, estado, ubicaci√≥n
- Estad√≠sticas de eventos
- Gesti√≥n de organizadores

**Uso:**
```typescript
import { eventsService } from './services/eventsService';

// Obtener eventos
const events = await eventsService.getAllEvents({
  status: 'publicado',
  category: 'concierto'
});

// Crear evento
const newEvent = await eventsService.createEvent(eventData);
```

### 5. Servicio de Solicitudes (`musicianRequestsService.ts`)

**Funcionalidades:**
- CRUD completo de solicitudes
- Filtrado por instrumento, estado, ubicaci√≥n
- Estad√≠sticas de solicitudes
- Gesti√≥n de m√∫sicos asignados

**Uso:**
```typescript
import { musicianRequestsService } from './services/musicianRequestsService';

// Obtener solicitudes
const requests = await musicianRequestsService.getAllRequests({
  status: 'pendiente',
  instrument: 'guitarra'
});

// Crear solicitud
const newRequest = await musicianRequestsService.createRequest(requestData);
```

## üõ°Ô∏è Manejo de Errores

### Tipos de Error

```typescript
export interface ApiError {
  message: string;
  status?: number;
  code?: string;
  details?: any;
}
```

### Manejo Autom√°tico

El sistema maneja autom√°ticamente:

1. **Errores 401 (No autorizado)**: Logout autom√°tico
2. **Errores de red**: Reintentos autom√°ticos
3. **Errores de timeout**: Configuraci√≥n personalizable
4. **Errores de validaci√≥n**: Mensajes descriptivos

### Ejemplo de Manejo

```typescript
try {
  const users = await mobileUsersService.getAllUsers();
} catch (error) {
  if (error instanceof ApiError) {
    console.error(`Error ${error.status}: ${error.message}`);
  } else {
    console.error('Error inesperado:', error);
  }
}
```

## üîê Autenticaci√≥n

### Flujo de Autenticaci√≥n

1. **Login**: Usuario se autentica
2. **Token Storage**: JWT se guarda en localStorage
3. **Auto-refresh**: Token se renueva autom√°ticamente
4. **Logout**: Tokens se limpian del localStorage

### Verificaci√≥n de Permisos

```typescript
// Verificar si es admin
if (authService.isAdmin()) {
  // Mostrar funcionalidades de admin
}

// Verificar nivel de permisos
const level = authService.getPermissionLevel();
if (level >= 3) {
  // Funcionalidades de admin senior
}
```

## üîÑ Interceptores

### Request Interceptor

```typescript
// Agrega token autom√°ticamente
instance.interceptors.request.use(config => {
  const token = localStorage.getItem('token');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});
```

### Response Interceptor

```typescript
// Maneja errores autom√°ticamente
instance.interceptors.response.use(
  response => response,
  error => {
    if (error.response?.status === 401) {
      // Logout autom√°tico
      authService.logout();
    }
    return Promise.reject(error);
  }
);
```

## üîÅ Reintentos Autom√°ticos

### Configuraci√≥n

```typescript
const retryConfig = {
  maxRetries: 3,
  retryDelay: 1000,
};
```

### Comportamiento

1. **Primer intento**: Request normal
2. **Error de red**: Espera 1 segundo
3. **Segundo intento**: Request con delay
4. **Error persistente**: Espera 2 segundos
5. **Tercer intento**: Request final
6. **Fallo**: Lanza error

## üìù Tipos TypeScript

### Respuestas de API

```typescript
export interface ApiResponse<T = any> {
  success: boolean;
  data?: T;
  message?: string;
  error?: string;
  status?: number;
}
```

### Paginaci√≥n

```typescript
export interface PaginatedResponse<T> {
  data: T[];
  total: number;
  page: number;
  limit: number;
  totalPages: number;
}
```

## üí° Ejemplos de Uso

### Hook de Usuarios M√≥viles

```typescript
import { useMobileUsers } from '../hooks/useMobileUsers';

export const MobileUsersComponent = () => {
  const {
    users,
    loading,
    error,
    stats,
    createUser,
    updateUser,
    deleteUser,
    blockUser
  } = useMobileUsers();

  const handleCreateUser = async (userData) => {
    try {
      await createUser(userData);
      // Usuario creado exitosamente
    } catch (error) {
      // Manejar error
    }
  };

  return (
    <div>
      {loading && <LoadingSpinner />}
      {error && <ErrorMessage message={error} />}
      {users.map(user => (
        <UserCard key={user._id} user={user} />
      ))}
    </div>
  );
};
```

### Servicio Directo

```typescript
import { mobileUsersService } from '../services/mobileUsersService';

const handleFetchUsers = async () => {
  try {
    const response = await mobileUsersService.getAllUsers({
      status: 'active',
      roll: 'musico'
    });
    
    console.log(`Total usuarios: ${response.total}`);
    setUsers(response.users);
  } catch (error) {
    console.error('Error al obtener usuarios:', error);
  }
};
```

## üîÑ Migraci√≥n

### De Sistema Anterior

1. **Reemplazar imports**:
   ```typescript
   // Antes
   import { get, post, put, del } from './httpClient';
   
   // Ahora
   import { apiService } from './services/api';
   ```

2. **Actualizar llamadas**:
   ```typescript
   // Antes
   const response = await get('/endpoint');
   
   // Ahora
   const response = await apiService.get('/endpoint');
   ```

3. **Usar servicios espec√≠ficos**:
   ```typescript
   // Antes
   const users = await getAllMobileUsers();
   
   // Ahora
   const response = await mobileUsersService.getAllUsers();
   ```

## üîß Troubleshooting

### Problemas Comunes

1. **Error 401 persistente**:
   - Verificar token en localStorage
   - Limpiar localStorage y relogin

2. **Requests no se env√≠an**:
   - Verificar configuraci√≥n de BASE_URL
   - Revisar interceptores

3. **Errores de tipos**:
   - Verificar imports de tipos
   - Actualizar interfaces si es necesario

4. **Reintentos excesivos**:
   - Ajustar configuraci√≥n de retry
   - Verificar conectividad de red

### Debug

```typescript
// Habilitar logs detallados
console.log('API Config:', API_CONFIG);
console.log('Current Token:', authService.getToken());
console.log('User:', authService.getCurrentUser());
```

## üìä M√©tricas y Monitoreo

### Logs Autom√°ticos

El sistema registra autom√°ticamente:

- ‚úÖ Requests exitosos
- ‚ùå Requests fallidos
- üîÑ Reintentos
- üîê Eventos de autenticaci√≥n

### Ejemplo de Logs

```
üöÄ GET /admin/users
‚úÖ GET /admin/users - 200
‚ùå POST /auth/login - 401
üîÑ Reintento 1/3 para login
üîê Token expirado, usuario deslogueado
```

## üöÄ Pr√≥ximas Mejoras

1. **Cache inteligente** para requests frecuentes
2. **WebSocket integration** para tiempo real
3. **Offline support** con queue de requests
4. **Analytics avanzados** de uso de API
5. **Rate limiting** autom√°tico
6. **Compresi√≥n de requests** para optimizar ancho de banda

---

## üìû Soporte

Para problemas o preguntas sobre el sistema de API:

1. Revisar esta documentaci√≥n
2. Verificar logs de consola
3. Comprobar configuraci√≥n de endpoints
4. Validar conectividad con backend

**¬°El Sistema de API Centralizado est√° listo para conectar tu aplicaci√≥n admin con el backend de MussikOn!** üéµ 