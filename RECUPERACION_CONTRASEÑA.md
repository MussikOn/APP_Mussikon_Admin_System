# üîê Sistema de Recuperaci√≥n de Contrase√±a - SuperAdmin

## üìã **Descripci√≥n General**

Sistema completo de recuperaci√≥n de contrase√±a **exclusivo para usuarios con rol "superadmin"**. Utiliza **nodemailer** para enviar c√≥digos de verificaci√≥n por email y permite restablecer la contrase√±a de forma segura.

## üéØ **Caracter√≠sticas Principales**

### **‚úÖ Seguridad**
- **Solo para superadmin** - Restricci√≥n de acceso por rol
- **C√≥digos de 6 d√≠gitos** - Generaci√≥n aleatoria segura
- **Expiraci√≥n autom√°tica** - 10 minutos de validez
- **Validaci√≥n de contrase√±a** - Requisitos de seguridad
- **Limpieza autom√°tica** - C√≥digos expirados se eliminan

### **‚úÖ UX/UI**
- **Proceso por pasos** - Stepper visual con 3 etapas
- **Validaci√≥n en tiempo real** - Feedback inmediato
- **Notificaciones** - Snackbar para confirmaciones
- **Dise√±o responsive** - Adaptable a todos los dispositivos
- **Tema oscuro/claro** - Consistente con el sistema

### **‚úÖ Funcionalidades**
- **Solicitud de c√≥digo** - Env√≠o por email
- **Verificaci√≥n de c√≥digo** - Validaci√≥n de 6 d√≠gitos
- **Restablecimiento** - Nueva contrase√±a segura
- **Redirecci√≥n autom√°tica** - Al login tras completar

## üîß **Backend - Implementaci√≥n**

### **1. Controladores Agregados**

**Archivo:** `../app_mussikon_express/src/controllers/authController.ts`

#### **‚úÖ forgotPasswordController**
```typescript
// Solicitar recuperaci√≥n de contrase√±a (solo superadmin)
export const forgotPasswordController = async (req: Request, res: Response) => {
  // Validaciones:
  // - Email requerido y v√°lido
  // - Usuario debe existir
  // - Usuario debe ser superadmin
  // - Genera c√≥digo de 6 d√≠gitos
  // - Env√≠a email con nodemailer
  // - Guarda c√≥digo temporalmente (10 min)
}
```

#### **‚úÖ verifyCodeController**
```typescript
// Verificar c√≥digo de recuperaci√≥n
export const verifyCodeController = async (req: Request, res: Response) => {
  // Validaciones:
  // - Email y c√≥digo requeridos
  // - Usuario debe ser superadmin
  // - C√≥digo debe existir y no estar expirado
  // - C√≥digo debe coincidir
}
```

#### **‚úÖ resetPasswordController**
```typescript
// Restablecer contrase√±a
export const resetPasswordController = async (req: Request, res: Response) => {
  // Validaciones:
  // - Email, c√≥digo y nueva contrase√±a requeridos
  // - Contrase√±a debe cumplir requisitos de seguridad
  // - Usuario debe ser superadmin
  // - C√≥digo debe ser v√°lido
  // - Hashea nueva contrase√±a con bcrypt
  // - Actualiza en Firebase
  // - Elimina c√≥digo usado
}
```

### **2. Rutas Agregadas**

**Archivo:** `../app_mussikon_express/src/routes/authRoutes.ts`

```typescript
// POST /auth/forgot-password
router.post("/forgot-password", asyncHandler(forgotPasswordController));

// POST /auth/verify-code
router.post("/verify-code", asyncHandler(verifyCodeController));

// POST /auth/reset-password
router.post("/reset-password", asyncHandler(resetPasswordController));
```

### **3. Funciones de Soporte**

#### **‚úÖ Generaci√≥n de C√≥digos**
```typescript
function generateVerificationCode(): string {
  return Math.floor(100000 + Math.random() * 900000).toString();
}
```

#### **‚úÖ Limpieza Autom√°tica**
```typescript
function cleanupExpiredCodes() {
  const now = Date.now();
  for (const [email, data] of verificationCodes.entries()) {
    if (data.expiresAt < now) {
      verificationCodes.delete(email);
    }
  }
}

// Ejecutar cada 5 minutos
setInterval(cleanupExpiredCodes, 5 * 60 * 1000);
```

#### **‚úÖ Email HTML Personalizado**
```typescript
const html = `<!DOCTYPE html>
<html lang="es">
<head>
  <title>Recuperar Contrase√±a - MusikOn</title>
</head>
<body>
  <!-- Email con dise√±o profesional -->
  <!-- Logo, c√≥digo de verificaci√≥n, instrucciones -->
  <!-- Mensaje de seguridad -->
</body>
</html>`;
```

## üîß **Frontend - Implementaci√≥n**

### **1. Servicio de Autenticaci√≥n**

**Archivo:** `src/services/authService.ts`

#### **‚úÖ Interfaces Agregadas**
```typescript
export interface ForgotPasswordData {
  userEmail: string;
}

export interface VerifyCodeData {
  userEmail: string;
  code: string;
}

export interface ResetPasswordData {
  userEmail: string;
  code: string;
  newPassword: string;
}
```

#### **‚úÖ Funciones Agregadas**
```typescript
// Solicitar recuperaci√≥n
export async function forgotPassword(data: ForgotPasswordData): Promise<AuthResponse>

// Verificar c√≥digo
export async function verifyCode(data: VerifyCodeData): Promise<AuthResponse>

// Restablecer contrase√±a
export async function resetPassword(data: ResetPasswordData): Promise<AuthResponse>
```

### **2. Configuraci√≥n de API**

**Archivo:** `src/config/apiConfig.ts`

```typescript
export const API_CONFIG = {
  ENDPOINTS: {
    FORGOT_PASSWORD: '/auth/forgot-password',
    VERIFY_CODE: '/auth/verify-code',
    RESET_PASSWORD: '/auth/reset-password',
    // ... otros endpoints
  }
};
```

### **3. Componente de Recuperaci√≥n**

**Archivo:** `src/features/auth/ForgotPassword.tsx`

#### **‚úÖ Caracter√≠sticas del Componente**
- **Stepper de 3 pasos** - Proceso visual claro
- **Validaci√≥n robusta** - Email, c√≥digo, contrase√±a
- **Estados de carga** - Feedback visual
- **Manejo de errores** - Mensajes espec√≠ficos
- **Notificaciones** - Snackbar para confirmaciones

#### **‚úÖ Pasos del Proceso**
1. **Solicitar C√≥digo**
   - Input de email
   - Validaci√≥n de formato
   - Env√≠o de solicitud
   - Confirmaci√≥n de env√≠o

2. **Verificar C√≥digo**
   - Input de 6 d√≠gitos
   - Validaci√≥n de longitud
   - Verificaci√≥n con backend
   - Confirmaci√≥n de validez

3. **Nueva Contrase√±a**
   - Input de nueva contrase√±a
   - Input de confirmaci√≥n
   - Validaci√≥n de seguridad
   - Actualizaci√≥n en backend

### **4. Integraci√≥n en Login**

**Archivo:** `src/features/auth/index.tsx`

#### **‚úÖ Cambios Realizados**
- **Link de recuperaci√≥n** - "¬øOlvidaste tu contrase√±a?"
- **Estado de pantalla** - Toggle entre login y recuperaci√≥n
- **Navegaci√≥n** - Bot√≥n de regreso
- **Dise√±o mejorado** - Header y footer actualizados

## üé® **Dise√±o y UX**

### **‚úÖ Stepper Visual**
```typescript
const steps = [
  'Solicitar C√≥digo',
  'Verificar C√≥digo', 
  'Nueva Contrase√±a'
];
```

### **‚úÖ Validaciones**
```typescript
// Email
const validateEmail = (email: string) => {
  return /^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email);
};

// Contrase√±a
const validatePassword = (password: string) => {
  return /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{6,}$/.test(password);
};
```

### **‚úÖ Estados de Carga**
- **Spinner durante operaciones**
- **Botones deshabilitados**
- **Mensajes de progreso**
- **Indicadores visuales**

### **‚úÖ Notificaciones**
```typescript
const [snackbar, setSnackbar] = useState<{
  open: boolean;
  message: string;
  severity: 'success' | 'error' | 'info';
}>({ open: false, message: '', severity: 'info' });
```

## üîí **Seguridad**

### **‚úÖ Restricciones de Acceso**
- **Solo superadmin** puede usar la recuperaci√≥n
- **Validaci√≥n de rol** en cada endpoint
- **Verificaci√≥n de usuario** en base de datos

### **‚úÖ Validaci√≥n de C√≥digos**
- **6 d√≠gitos aleatorios** - 900,000 combinaciones
- **Expiraci√≥n de 10 minutos** - Tiempo limitado
- **Uso √∫nico** - Se elimina tras usar
- **Limpieza autom√°tica** - C√≥digos expirados

### **‚úÖ Requisitos de Contrase√±a**
- **M√≠nimo 6 caracteres**
- **Al menos una may√∫scula**
- **Al menos una min√∫scula**
- **Al menos un n√∫mero**
- **Al menos un car√°cter especial**

### **‚úÖ Protecci√≥n de Datos**
- **Hashing con bcrypt** - Contrase√±as seguras
- **Validaci√≥n de email** - Formato correcto
- **Sanitizaci√≥n de inputs** - Prevenci√≥n de inyecci√≥n
- **Logs de auditor√≠a** - Seguimiento de acciones

## üìß **Email con Nodemailer**

### **‚úÖ Configuraci√≥n**
```typescript
// Usa la funci√≥n sendEmail existente
await sendEmail(
  userEmail,
  "Recuperar Contrase√±a - MusikOn",
  `Tu c√≥digo de verificaci√≥n es: ${verificationCode}`,
  html
);
```

### **‚úÖ Dise√±o del Email**
- **Logo de MusikOn**
- **C√≥digo prominente** - 6 d√≠gitos grandes
- **Instrucciones claras** - Paso a paso
- **Mensaje de seguridad** - Advertencia importante
- **Dise√±o responsive** - Funciona en m√≥viles

## üß™ **Testing y Verificaci√≥n**

### **‚úÖ Flujo de Prueba**
1. **Crear usuario superadmin** en Firebase
2. **Ir a login** y hacer click en "¬øOlvidaste tu contrase√±a?"
3. **Ingresar email** del superadmin
4. **Verificar email** - Debe recibir c√≥digo
5. **Ingresar c√≥digo** de 6 d√≠gitos
6. **Verificar c√≥digo** - Debe avanzar al paso 3
7. **Ingresar nueva contrase√±a** - Cumplir requisitos
8. **Confirmar contrase√±a** - Debe coincidir
9. **Actualizar contrase√±a** - Debe funcionar
10. **Redirecci√≥n autom√°tica** - Al login

### **‚úÖ Casos de Error**
- **Email inv√°lido** - Validaci√≥n de formato
- **Usuario no existe** - Mensaje espec√≠fico
- **Usuario no es superadmin** - Restricci√≥n de acceso
- **C√≥digo inv√°lido** - Validaci√≥n de 6 d√≠gitos
- **C√≥digo expirado** - Tiempo l√≠mite
- **Contrase√±a d√©bil** - Requisitos de seguridad
- **Contrase√±as no coinciden** - Validaci√≥n de confirmaci√≥n

## üìù **Notas Importantes**

### **‚úÖ Configuraci√≥n Requerida**
- **Nodemailer configurado** en el backend
- **Firebase funcionando** para base de datos
- **Usuario superadmin** creado previamente
- **Variables de entorno** para email configuradas

### **‚úÖ Limitaciones**
- **Solo para superadmin** - No disponible para otros roles
- **C√≥digo de 10 minutos** - Expiraci√≥n autom√°tica
- **Un c√≥digo por email** - No se pueden solicitar m√∫ltiples
- **Requiere email v√°lido** - Para recibir c√≥digo

### **‚úÖ Mejoras Futuras**
- **Captcha** para prevenir spam
- **Rate limiting** por IP
- **Notificaciones push** como alternativa
- **Historial de cambios** de contrase√±a
- **Autenticaci√≥n de dos factores**

## üöÄ **Instalaci√≥n y Uso**

### **‚úÖ Backend**
1. **Reiniciar servidor** para cargar nuevos endpoints
2. **Verificar nodemailer** configurado correctamente
3. **Probar endpoints** con Postman o similar

### **‚úÖ Frontend**
1. **Reiniciar aplicaci√≥n** para cargar nuevos componentes
2. **Verificar rutas** funcionando correctamente
3. **Probar flujo completo** con usuario superadmin

### **‚úÖ Verificaci√≥n**
1. **Login con superadmin** existente
2. **Probar recuperaci√≥n** de contrase√±a
3. **Verificar email** recibido
4. **Completar proceso** de restablecimiento
5. **Login con nueva contrase√±a**

## üîç **Debugging**

### **‚úÖ Logs del Backend**
```bash
# Verificar env√≠o de email
console.log('üìß Enviando email a:', userEmail);

# Verificar generaci√≥n de c√≥digo
console.log('üîê C√≥digo generado:', verificationCode);

# Verificar validaciones
console.log('‚úÖ Usuario verificado:', user.roll);
```

### **‚úÖ Logs del Frontend**
```bash
# Verificar solicitud
console.log('üìß Solicitando recuperaci√≥n:', userEmail);

# Verificar respuesta
console.log('‚úÖ C√≥digo enviado correctamente');

# Verificar errores
console.error('‚ùå Error al enviar c√≥digo:', error);
```

### **‚úÖ Verificaci√≥n de Email**
- **Revisar carpeta spam** si no llega
- **Verificar configuraci√≥n** de nodemailer
- **Probar con email v√°lido** de superadmin
- **Revisar logs** del servidor

¬°El sistema de recuperaci√≥n de contrase√±a est√° completamente implementado y listo para usar! üéâ 